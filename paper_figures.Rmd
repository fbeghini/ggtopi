---
title: "Paper figures"
author: "Francesco Beghini"
date: "January 6, 2019"
output: 
  html_document: 
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, paged.print=FALSE, echo=FALSE)
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
library(phyloseq)
library(magrittr)
library(tidyverse)
library(reshape2)
library(ggsignif)
library(DESeq2)

source('R/loadQiimeData.R')
source('R/ggtheme.R')
source('R/calculatePairwiseDistances.R')
```

```{r QIIME data loading, cache=TRUE}
gg_topi <- loadQiimeData()
mappingfile <- data.frame(sample_data(gg_topi))
gg_topi.genus <- tax_glom(gg_topi,taxrank = "Genus")
gg_topi.genus.relab <- transform_sample_counts(gg_topi.genus, function(x) x/sum(x))

gg_topi.family <- tax_glom(gg_topi,taxrank = "Family")
gg_topi.family.relab <- transform_sample_counts(gg_topi.family, function(x) x/sum(x))
```

# Figure 3
## Panel A: Alpha diversity controls T1 vs T2 and pre and post challenge T2 vs T3 
```{r Calculate alpha diversity, cache=TRUE}
alpha_div <- estimate_richness(gg_topi) %>% bind_cols(data.frame(sample_data(gg_topi)))
```

```{r}
filt_alpha <- alpha_div %>% 
  filter(timepoint %in% c('T1', 'T2', 'T3')) %>%
  select('Description','condizione','timepoint','Observed', 'se.chao1', 'Simpson', 'Shannon') %>%
  rename('se.chao1' = 'Chao1') %>%
  mutate(t=as.numeric(stringr::str_sub(timepoint,2,2))) %>% droplevels()

ttest_res <- data.frame()
for ( ts in list(c('T1','T2'), c('T2','T3')) ){
  for( measure in c('Observed', 'Chao1', 'Simpson', 'Shannon') ){
    ttest_res %<>% bind_rows( data.frame(Measure = measure,
                                         Timepoint = paste(ts, collapse = ' vs '),
                                         pvalue = with(filt_alpha %>% filter(timepoint %in% ts), t.test(as.formula(paste(measure, 't', sep = '~'))))$p.value))
  }
}
```

```{r}
knitr::kable(ttest_res)
```


```{r Plot boxplot}
filt_alpha %>%
  melt(id.vars = c('Description','condizione','timepoint'), measure.vars =  c('Observed', 'Chao1', 'Simpson', 'Shannon')) %>%
  ggplot() +
  geom_boxplot(aes(timepoint, value)) +
  xlab('Timepoint') +
  ylab('Value') +
  facet_grid(variable~.,scales = 'free_y') +
  theme_minimal() +
  theme( strip.background = element_rect(colour = "transparent", fill = "transparent"),
           strip.text.y = element_text(angle = 0))
```


## Panel B: Beta diversity differences pre and post challange T2 vs T3
```{r, cache=TRUE}
distwu <- phyloseq::distance(gg_topi, "wunifrac")
ordwu <-  ordinate(gg_topi, method = "MDS", distance = distwu, weighted = TRUE) %>% plot_ordination(gg_topi, ., justDF = TRUE)
distanceswu <- calculate_pairwise_distances(distwu)
distancesbc <- calculate_pairwise_distances(phyloseq::distance(gg_topi, "bray"))
metadata_2cat <- mappingfile[mappingfile$timepoint %in% c('T2','T3'),]
distwu_2cat <- phyloseq::distance(subset_samples(gg_topi, timepoint %in% c('T2','T3')), "wunifrac")
permanova <- vegan::adonis(formula = distwu_2cat ~ merge_timepoint, data = metadata_2cat)
```

```{r Plot ordination}
subset(ordwu, timepoint %in% c('T2','T3')) %>%
ggplot(aes(Axis.1, Axis.2)) +
  geom_point(aes(color=timepoint), size=3, alpha=.8) +
  scale_color_brewer(name = "Timepoint", palette="Dark2") + 
  theme_minimal() +
  annotation_custom(grob = grid::textGrob(label = bquote(atop("p-value"==.(permanova$aov.tab$`Pr(>F)`[1]),R^2==.(signif(permanova$aov.tab$R2[1], 2)))),
    gp=grid::gpar(col="black", fontsize=13)),  xmin = 0.15, xmax = .15, ymin = -.05, ymax = -.05)
```

## Panel C: Differential abundance analysis highlighted Bacteroidales S24/7 and Lacnospiraceae as most differential abunant families.
```{r DESeq2 loading, cache=TRUE}
pds_genus <- phyloseq_to_deseq2(gg_topi.genus, design = ~timepoint)
dds_genus <- DESeq2::DESeq(pds_genus, parallel = TRUE, quiet = TRUE)
```

```{r DESeq2 T2 T3}
res_genus <- DESeq2::results(dds_genus, contrast = c('timepoint', 'T2','T3'), alpha = 0.05)
res.filt_genus <- res_genus[!is.na(res_genus$padj),]
res.filt_genus <- res.filt_genus[res.filt_genus$padj<0.05,]

t23_samples_idx_genus <- grep('T2|T3', sample_names(gg_topi.genus.relab), perl = TRUE)

genus_ab_t <- otu_table(gg_topi.genus.relab)[rownames(res.filt_genus), t23_samples_idx_genus] %>%
            data.frame %>%
            tibble::rownames_to_column("OTU") %>%
            tidyr::gather_("SampleID", "Abundance", setdiff(colnames(.), "OTU")) %>%
            mutate(timepoint=factor(stringr::str_sub(.$SampleID,12, 13)))
```

```{r}
lacno_bact_relabs <-genus_ab_t %>% bind_cols(data.frame(tax_table(gg_topi.genus.relab)[genus_ab_t$OTU,c('Phylum','Family','Genus')])) %>% filter(Family %in% c('Bacteroidales S24-7 group') | Genus %in% c('Lachnospiraceae NK4A136 group'))

lacno_bact_relabs %>% group_by(timepoint, interaction(Family, Genus)) %>% dplyr::summarise(Mean=mean(Abundance), SD = sd(Abundance)) %>% knitr::kable()

lacno_bact_relabs %>% 
  mutate(Taxonomy=interaction(Family, Genus)) %>%
  select(Abundance, Taxonomy, timepoint) %>%
  group_by(timepoint, Taxonomy) %>%
  summarise(Abundance = list(Abundance)) %>% 
  spread(timepoint, Abundance) %>% 
  group_by(Taxonomy) %>%
  dplyr::summarise("Wilcoxon p value"=wilcox.test(unlist(T2), unlist(T3), paired = TRUE)$p.value)  %>% knitr::kable()
```

```{r}
  lacno_bact_relabs %>%
  ggplot() +
    geom_boxplot(aes(timepoint, Abundance, fill=timepoint)) + 
    facet_wrap(interaction(Family, Genus) ~ ., scales = "free_x", as.table= T) +
    theme_minimal() +
    guides(fill=FALSE) +
    theme( strip.background = element_rect(colour = "transparent", fill = "transparent"),
           strip.text.x = element_text(size=12))

```

## Panel D: Ordination centroids beta diversity all timepoints 
```{r}
x <- ordinate(gg_topi, method = "MDS", distance = distwu, weighted = TRUE) %>% plot_ordination(gg_topi, ., justDF = TRUE)

centroids <- aggregate(cbind(Axis.1, Axis.2)~timepoint, x, mean)

ggplot(x, aes(Axis.1, Axis.2, color=timepoint)) +
  geom_point(size = 0.8) +
  geom_point(data=centroids, size = 4) + 
  theme_minimal()
```

## Panel ?: Ordination beta diversity T3 vs T7
```{r}
metadata_2cat <- mappingfile[mappingfile$timepoint %in% c('T7','T3'),]
distwu_2cat <- phyloseq::distance(subset_samples(gg_topi, timepoint %in% c('T7','T3')), "wunifrac")
permanova <- vegan::adonis(formula = distwu_2cat ~ merge_timepoint, data = metadata_2cat)

subset(ordwu, timepoint %in% c('T7','T3')) %>%
ggplot(aes(Axis.1, Axis.2)) +
  geom_point(aes(color=timepoint), size=3, alpha=.8) +
  scale_color_brewer(name = "Timepoint", palette="Dark2") + 
  theme_minimal() +
  annotation_custom(grob = grid::textGrob(bquote(atop(italic("p-value")==.(permanova$aov.tab$`Pr(>F)`[1]),italic(R^2)==.(signif(permanova$aov.tab$R2[1], 2)))), gp=grid::gpar(col="black", fontsize=10)),  xmin = 0, xmax = 0, ymin = .1, ymax = .1)
```


```{r, cache=TRUE}
ggtopi_subs <-subset_samples(gg_topi, timepoint %in% c('T3','T7'))
ggtopi_subs.relab <- transform_sample_counts(ggtopi_subs, function(x) x/sum(x))
ggtopi_subs.genus <- tax_glom(ggtopi_subs,taxrank = "Genus")
ggtopi_subs.genus.relab <- transform_sample_counts(ggtopi_subs.genus, function(x) x/sum(x))

mmtx <- model.matrix(object = ~timepoint + timepoint:real_vaccine + timepoint:real_bifido + timepoint:real_vaccine:real_bifido, data = data.frame(ggtopi_subs@sam_data))
idx <- which(apply(mmtx, 2, function(x) all(x==0)))
mmtx <- mmtx[,-idx]

pds_37 <- phyloseq_to_deseq2(ggtopi_subs, design = ~ timepoint + timepoint:real_vaccine + timepoint:real_bifido + timepoint:real_vaccine:real_bifido, ignoreRank = TRUE)
dds_37 <- DESeq2::DESeq(pds_37, parallel = TRUE, quiet = TRUE, full = mmtx)

pds_genus <- phyloseq_to_deseq2(ggtopi_subs.genus, design =  ~ timepoint + timepoint:real_vaccine + timepoint:real_bifido + timepoint:real_vaccine:real_bifido, ignoreRank = TRUE)
dds_genus <- DESeq2::DESeq(pds_genus, parallel = TRUE, quiet = TRUE, full = mmtx)
```

## Panel E: Boxplot of abundance of significant genera from DESeq2 differential analysis. Genera with median below 1% are filtered
```{r}
res37 <- DESeq2::results(dds_genus, name = "timepointT7", alpha = 0.05)
res37.filt <- res37[!is.na(res37$padj),]
res37.filt <- res37.filt[res37.filt$padj<0.05,]

t37_samples_idx <- grep('T7|T3', sample_names(ggtopi_subs), perl = TRUE)

genus_ab_t <- otu_table(ggtopi_subs.genus.relab)[rownames(res37.filt), ] %>%
            data.frame %>%
            tibble::rownames_to_column("OTU") %>%
            tidyr::gather_("SampleID", "Abundance", setdiff(colnames(.), "OTU")) %>%
            mutate(timepoint=stringr::str_sub(.$SampleID,12, 13))

genus_ab_t %>%
  bind_cols(data.frame(tax_table(ggtopi_subs.genus.relab)[genus_ab_t$OTU,c('Phylum','Family','Genus')])) %>%
  filter(OTU %in% (genus_ab_t %>%
  group_by(OTU, timepoint) %>%
  summarise(median=median(Abundance)) %>%
  group_by(OTU) %>%
  summarise(filt=min(median)>0.01) %>% filter(filt==TRUE))$OTU) %>%
  filter(Phylum != "Unassigned") %>%
  mutate(taxlab = ifelse(stringr::str_detect(Genus,'uncultured'), paste('Uncultured',Family,sep = ' '), paste(Genus))) %>%
ggplot() +
  geom_boxplot(aes(reorder(taxlab, Abundance, FUN = median), Abundance, fill=timepoint)) +
  facet_grid(Phylum ~ ., scales = "free", space = "free_y", as.table= T) +
  scale_fill_brewer(name = "Timepoint", palette="Dark2") +
  coord_flip() +
  xlab('') +
  ylab("Relative abundance") +
  theme_cm()
```

## Panel F: Abundance of Bacteroidales 24/7 and Lachnospiraceae NK4A136 through timepoints and treatment
```{r}
idx_247 <- which(tax_table(gg_topi.genus.relab)[,'Family'] == "Bacteroidales S24-7 group" & tax_table(gg_topi.genus.relab)[,'Genus'] == "uncultured bacterium")
idx_lachno <- which(tax_table(gg_topi.genus.relab)[,'Genus'] == "Lachnospiraceae NK4A136 group" )

otu_table(gg_topi.genus.relab)[c(idx_247,idx_lachno),] %>%
  data.frame %>%
  tibble::rownames_to_column("OTU") %>%
  tidyr::gather_("SampleID", "Abundance", setdiff(colnames(.), "OTU")) %>%
  mutate(timepoint=stringr::str_sub(.$SampleID,12, 13)) %>%
  mutate(condition= stringr::str_sub(.$SampleID,4, 6)) %>%
  bind_cols(data.frame(tax_table(gg_topi.genus.relab)[.$OTU,c('Phylum','Family','Genus')])) %>%
  mutate(taxlab = ifelse(stringr::str_detect(Genus,'uncultured'), paste('Uncultured',Family,sep = ' '), paste(Genus))) %>%
  ggplot() +
  geom_boxplot(aes(timepoint, Abundance, fill=condition)) +
  scale_fill_manual(name = "Treatment", values = c("#a6d854","#ffd92f","#66c2a5","#fc8d62")) +
  facet_wrap(facets = 'taxlab', nrow = 2, scales = "free", shrink = FALSE) +
  theme_cm() +
  ylab('Relative abundance') +
  xlab('Timepoint')
```

## Panel G: Scatterplot of tumor size and difference of \\beta diversity 
```{r}
brayc_ds <- distancesbc %>% 
  dplyr::filter(topo1==topo2) %>%
  dplyr::filter(timepoint1==3) %>%
  dplyr::filter(timepoint2>4) %>%
  dplyr::select(cols, timepoint2, value) %>%
  dplyr::left_join(mappingfile, by=c('cols' = 'Description'))

ds_corr_braycf <- data.frame()
for(x in unique(brayc_ds$timepoint2)){
  # for(y in levels(brayc_ds$condizione)){
    tmp_res <- with(brayc_ds %>% filter(timepoint2==x), cor.test(value, tumor_mass))
    ds_corr_braycf %<>% bind_rows(data.frame(timepoint = paste('T', x, '-T3',sep = ''), corr = signif(tmp_res$estimate,2), pval = signif(tmp_res$p.value,2), label = paste('p-value==',signif(tmp_res$p.value,2),'~italic(r)==', signif(tmp_res$estimate,2))))
}
```

```{r corr tumor braycurtis}
distancesbc %>% 
  dplyr::filter(topo1==topo2) %>%
  dplyr::filter(timepoint1==3) %>%
  dplyr::filter(timepoint2>4) %>%
  dplyr::select(cols, timepoint2, value) %>%
  dplyr::left_join(mappingfile, by=c('cols' = 'Description')) %>%
  mutate(timepoint = paste('T',timepoint2,'-T3',sep = '')) %>%
  ggplot(aes(value,tumor_mass)) +
  geom_point() +
  facet_wrap(facets = 'timepoint', ncol = 1) +
  geom_line(stat='smooth', method = 'lm', color='red', alpha=0.7, size=.7) + 
  ylab(bquote('Tumor mass'~( mm^3))) +
  xlab('Bray Curtis distance') +
  theme_cm() +
  geom_text(data = ds_corr_braycf, aes(x=0.4,y=2500, label=label), parse = TRUE, inherit.aes = FALSE)

```
