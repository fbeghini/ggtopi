---
title: "Paper figures"
author: "Francesco Beghini"
date: "January 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, paged.print=FALSE, echo=FALSE)
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
library(phyloseq)
library(magrittr)
library(tidyverse)
library(reshape2)
library(ggsignif)
library(DESeq2)

source('R/loadQiimeData.R')
```

```{r QIIME data loading}
gg_topi <- loadQiimeData()
gg_topi.genus <- tax_glom(gg_topi,taxrank = "Genus")
gg_topi.genus.relab <- transform_sample_counts(gg_topi.genus, function(x) x/sum(x))

gg_topi.family <- tax_glom(gg_topi,taxrank = "Family")
gg_topi.family.relab <- transform_sample_counts(gg_topi.family, function(x) x/sum(x))
```

# Figure 3
## Panel A: Alpha diversity controls T1 vs T2 and pre and post challenge T2 vs T3 
```{r Calculate alpha diversity}
alpha_div <- estimate_richness(gg_topi) %>% bind_cols(data.frame(sample_data(gg_topi)))
```

```{r}
filt_alpha <- alpha_div %>% 
  filter(timepoint %in% c('T1', 'T2', 'T3')) %>%
  select('Description','condizione','timepoint','Observed', 'se.chao1', 'Simpson', 'Shannon') %>%
  rename('se.chao1' = 'Chao1') %>%
  mutate(t=as.numeric(stringr::str_sub(timepoint,2,2))) %>% droplevels()

ttest_res <- data.frame()
for ( ts in list(c('T1','T2'), c('T2','T3')) ){
  for( measure in c('Observed', 'Chao1', 'Simpson', 'Shannon') ){
    ttest_res %<>% bind_rows( data.frame(Measure = measure,
                                         Timepoint = paste(ts, collapse = ' vs '),
                                         pvalue = with(filt_alpha %>% filter(timepoint %in% ts), t.test(as.formula(paste(measure, 't', sep = '~'))))$p.value))
  }
}
```

```{r}
knitr::kable(ttest_res)
```


```{r Plot boxplot}
filt_alpha %>%
  melt(id.vars = c('Description','condizione','timepoint'), measure.vars =  c('Observed', 'Chao1', 'Simpson', 'Shannon')) %>%
  ggplot() +
  geom_boxplot(aes(timepoint, value)) +
  xlab('Timepoint') +
  ylab('Value') +
  facet_grid(variable~.,scales = 'free_y') +
  theme_minimal() +
  theme( strip.background = element_rect(colour = "transparent", fill = "transparent"),
           strip.text.y = element_text(angle = 0))
```


## Panel B: Beta diversity differences pre and post challange T2 vs T3
```{r}
distwu <- phyloseq::distance(gg_topi, "wunifrac")
ordwu <-  ordinate(gg_topi, method = "MDS", distance = distwu, weighted = TRUE) %>% plot_ordination(gg_topi, ., justDF = TRUE)
distanceswu <- calculate_pairwise_distances(distwu)
metadata_2cat <- mappingfile[mappingfile$timepoint %in% c('T2','T3'),]
distwu_2cat <- phyloseq::distance(subset_samples(gg_topi, timepoint %in% c('T2','T3')), "wunifrac")
permanova <- vegan::adonis(formula = distwu_2cat ~ merge_timepoint, data = metadata_2cat)
```

```{r Plot ordination}
subset(ordwu, timepoint %in% c('T2','T3')) %>%
ggplot(aes(Axis.1, Axis.2)) +
  geom_point(aes(color=timepoint), size=3, alpha=.8) +
  scale_color_brewer(name = "Timepoint", palette="Dark2") + 
  theme_minimal() +
  annotation_custom(grob = grid::textGrob(label = bquote(atop("p-value"==.(permanova$aov.tab$`Pr(>F)`[1]),R^2==.(signif(permanova$aov.tab$R2[1], 2)))),
    gp=grid::gpar(col="black", fontsize=13)),  xmin = 0.15, xmax = .15, ymin = -.05, ymax = -.05)
```

## Panel C: Differential abundance analysis highlighted Bacteroidales S24/7 and Lacnospiraceae as most differential abunant families.
```{r DESeq2 loading, cache=TRUE}
pds_genus <- phyloseq_to_deseq2(gg_topi.genus, design = ~timepoint)
dds_genus <- DESeq2::DESeq(pds_genus, parallel = TRUE, quiet = TRUE)
res_genus <- DESeq2::results(dds_genus, contrast = c('timepoint', 'T2','T3'), alpha = 0.05)
res.filt_genus <- res_genus[!is.na(res_genus$padj),]
res.filt_genus <- res.filt_genus[res.filt_genus$padj<0.05,]

t23_samples_idx_genus <- grep('T2|T3', sample_names(gg_topi.genus.relab), perl = TRUE)

genus_ab_t <- otu_table(gg_topi.genus.relab)[rownames(res.filt_genus), t23_samples_idx_genus] %>%
            data.frame %>%
            tibble::rownames_to_column("OTU") %>%
            tidyr::gather_("SampleID", "Abundance", setdiff(colnames(.), "OTU")) %>%
            mutate(timepoint=factor(stringr::str_sub(.$SampleID,12, 13)))
```

```{r}
lacno_bact_relabs <-genus_ab_t %>% bind_cols(data.frame(tax_table(gg_topi.genus.relab)[genus_ab_t$OTU,c('Phylum','Family','Genus')])) %>% filter(Family %in% c('Bacteroidales S24-7 group') | Genus %in% c('Lachnospiraceae NK4A136 group'))

lacno_bact_relabs %>% group_by(timepoint, interaction(Family, Genus)) %>% dplyr::summarise(Mean=mean(Abundance), SD = sd(Abundance)) %>% knitr::kable()

lacno_bact_relabs %>% 
  mutate(Taxonomy=interaction(Family, Genus)) %>%
  select(Abundance, Taxonomy, timepoint) %>%
  group_by(timepoint, Taxonomy) %>%
  summarise(Abundance = list(Abundance)) %>% 
  spread(timepoint, Abundance) %>% 
  group_by(Taxonomy) %>%
  dplyr::summarise("Wilcoxon p value"=wilcox.test(unlist(T2), unlist(T3), paired = TRUE)$p.value)  %>% knitr::kable()
```

```{r}
  lacno_bact_relabs %>%
  ggplot() +
    geom_boxplot(aes(timepoint, Abundance, fill=timepoint)) + 
    facet_wrap(interaction(Family, Genus) ~ ., scales = "free_x", as.table= T) +
    theme_minimal() +
    guides(fill=FALSE) +
    theme( strip.background = element_rect(colour = "transparent", fill = "transparent"),
           strip.text.x = element_text(size=12))

```

## Panel D
```{r}

```

